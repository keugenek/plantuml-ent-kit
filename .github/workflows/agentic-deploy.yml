name: Agentic Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.deploy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Validate changes
        id: check
        run: |
          # Check what changed
          CHANGED=$(git diff --name-only HEAD~1 2>/dev/null || echo "initial")
          echo "Changed files: $CHANGED"
          
          # Skip deploy for docs-only changes
          if echo "$CHANGED" | grep -qvE '\.(md|txt|puml)$'; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "üöÄ Code changes detected - will deploy"
          else
            echo "deploy=false" >> $GITHUB_OUTPUT  
            echo "üìù Docs-only changes - skipping deploy"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true'
    outputs:
      status: ${{ steps.deploy.outcome }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy
        id: deploy
        continue-on-error: true
        run: |
          echo "ü§ñ Agentic deploy started at $(date)"
          echo "Commit: ${{ github.sha }}"
          
          # Simulate deployment (replace with actual deploy)
          # Example: npm run build && npm run deploy
          echo "‚úÖ Deploy complete"

      - name: Check deploy result
        if: steps.deploy.outcome == 'failure'
        run: |
          echo "‚ùå Deploy failed!"
          exit 1

  self-heal:
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'failure'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Analyze failure
        id: analyze
        run: |
          echo "üîç Analyzing failure..."
          echo "Failed commit: ${{ github.sha }}"
          
          # Get error logs from previous job
          echo "Checking for common issues..."
          
          # Check if it's a config issue vs code issue
          CHANGED=$(git diff --name-only HEAD~1 2>/dev/null || echo "")
          if echo "$CHANGED" | grep -q "\.yml$\|\.yaml$\|\.json$"; then
            echo "type=config" >> $GITHUB_OUTPUT
            echo "‚öôÔ∏è Config change detected - may need manual review"
          else
            echo "type=code" >> $GITHUB_OUTPUT
            echo "üíª Code change - attempting auto-rollback"
          fi

      - name: Auto-rollback (code issues)
        if: steps.analyze.outputs.type == 'code'
        run: |
          echo "üîÑ Self-healing: creating revert commit"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          PREV_SHA=$(git rev-parse HEAD~1)
          echo "Reverting to: $PREV_SHA"
          
          # Create revert
          git revert --no-commit HEAD
          git commit -m "ü§ñ Auto-rollback: reverting ${{ github.sha }}"
          git push origin main

      - name: Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const failureType = '${{ steps.analyze.outputs.type }}';
            const isAutoRolled = failureType === 'code';
            
            const body = `## üö® Incident Report
            
**Commit:** \`${{ github.sha }}\`
**Time:** ${new Date().toISOString()}
**Failure Type:** ${failureType === 'config' ? 'Configuration' : 'Code'}
**Auto-rollback:** ${isAutoRolled ? '‚úÖ Executed' : '‚ùå Skipped (config change)'}

### Action Required
${isAutoRolled 
  ? 'System auto-recovered. Please investigate root cause.'
  : '‚ö†Ô∏è Manual intervention required. Config changes need human review.'}

### Failed Workflow
[View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: \`ü§ñ Deploy failed: \${context.sha.slice(0,7)} [\${failureType}]\`,
              body: body,
              labels: ['incident', 'automated', failureType]
            });

  notify-success:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.result == 'success'
    steps:
      - name: Log success
        run: |
          echo "‚úÖ Deploy succeeded for ${{ github.sha }}"
          echo "No incidents. System healthy."
