name: Agentic Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '**.puml'
      - 'docs/**'
      - 'catalogue/**'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if deploy needed
        id: check
        run: |
          echo "ðŸ¤– Agentic deploy check"
          echo "Commit: ${{ github.sha }}"
          echo "deploy=true" >> $GITHUB_OUTPUT

      - name: Deploy
        if: steps.check.outputs.deploy == 'true'
        run: |
          echo "âœ… Deploy would happen here"
          echo "For now, just validating workflow works"

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - uses: actions/checkout@v4
      
      - name: Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– Deploy failed: ' + context.sha.slice(0,7),
              body: '## Incident Report\n\nCommit: ' + context.sha + '\nTime: ' + new Date().toISOString() + '\n\nPlease investigate.',
              labels: ['incident', 'automated']
            });
