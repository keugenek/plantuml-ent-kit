# PlantUML Auto-Render Workflow
# This workflow automatically renders PlantUML diagrams and commits them back to the repo
# Designed for agentic workflows - works on all branches

name: Render PlantUML Diagrams

on:
  # Triggers on push to any branch - enables agentic workflows
  push:
    branches: [ "**" ]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'

  pull_request:
    branches: [ "main" ]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'

  # Allows manual triggering from Actions tab
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download PlantUML
        run: |
          mkdir -p /tmp/plantuml
          curl -L -o /tmp/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.8/plantuml-1.2024.8.jar

      - name: Find and Render PlantUML files
        run: |
          # Find all PlantUML files and render them
          find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | while read file; do
            dir=$(dirname "$file")
            filename=$(basename "$file")
            name="${filename%.*}"

            # Determine output directory (sibling 'images' folder)
            parent_dir=$(dirname "$dir")
            if [[ "$dir" == *"/uml"* ]]; then
              # If in a /uml folder, output to sibling /images folder
              output_dir="${dir/\/uml/\/images}"
            else
              # Otherwise, create images folder next to the file
              output_dir="$dir/images"
            fi

            mkdir -p "$output_dir"

            echo "Rendering: $file -> $output_dir/$name.png"
            java -jar /tmp/plantuml/plantuml.jar -tpng -o "$(cd "$dir" && pwd)/../images" "$file" 2>/dev/null || \
            java -jar /tmp/plantuml/plantuml.jar -tpng -o "$output_dir" "$file"
          done

      - name: Commit rendered diagrams
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all PNG files in images directories
          git add -A "**/*.png" 2>/dev/null || true
          git add -A "**/images/*.png" 2>/dev/null || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-render PlantUML diagrams

Automatically generated by GitHub Actions
Triggered by: ${{ github.event_name }}
Commit: ${{ github.sha }}"
            git push
          fi
