# PlantUML Auto-Render Workflow
# Validates, renders PlantUML diagrams to PNG + SVG and commits back to repo
# Images are cached by jsDelivr CDN for fast global delivery

name: Render PlantUML Diagrams

on:
  push:
    branches: ["**"]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'
  pull_request:
    branches: ["main"]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'
  workflow_dispatch:

jobs:
  validate-and-render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate PlantUML files
        run: |
          echo "ðŸ” Validating PlantUML files..."
          ERRORS=0

          for file in $(find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | grep -v node_modules); do
            echo "  Checking $file..."

            if ! grep -q "@startuml" "$file"; then
              echo "    âŒ Missing @startuml"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            if ! grep -q "@enduml" "$file"; then
              echo "    âŒ Missing @enduml"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            if grep -q "participant" "$file" && grep -qE "^component|^  component" "$file"; then
              echo "    âŒ Mixing participant (sequence) with component elements"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            if grep -qE "component\([^)]+\)\s*\{" "$file"; then
              echo "    âŒ Text inside component() macro - use notes instead"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            echo "    âœ… Valid"
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Validation failed with $ERRORS error(s)"
            exit 1
          fi

          echo "âœ… All PlantUML files validated successfully!"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache PlantUML JAR
        uses: actions/cache@v4
        with:
          path: /tmp/plantuml
          key: plantuml-1.2024.8

      - name: Download PlantUML
        run: |
          if [ ! -f /tmp/plantuml/plantuml.jar ]; then
            mkdir -p /tmp/plantuml
            curl -L -o /tmp/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.8/plantuml-1.2024.8.jar
          fi

      - name: Render PlantUML files (PNG + SVG)
        run: |
          echo "ðŸŽ¨ Rendering PlantUML diagrams..."

          find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | while read file; do
            dir=$(dirname "$file")
            filename=$(basename "$file")
            name="${filename%.*}"

            # Determine output directory (sibling 'images' folder)
            if [[ "$dir" == *"/uml"* ]]; then
              output_dir="${dir/\/uml/\/images}"
            else
              output_dir="$dir/images"
            fi

            mkdir -p "$output_dir"
            output_path=$(realpath "$output_dir")

            echo "  Rendering: $file"
            echo "  Output: $output_dir/$name.{png,svg}"

            # Render to PNG (for compatibility)
            java -jar /tmp/plantuml/plantuml.jar -tpng -o "$output_path" "$file"

            # Render to SVG (for quality + smaller size)
            java -jar /tmp/plantuml/plantuml.jar -tsvg -o "$output_path" "$file"

            if [ -f "$output_dir/$name.png" ] && [ -f "$output_dir/$name.svg" ]; then
              echo "    âœ… PNG + SVG created"
            elif [ -f "$output_dir/$name.png" ]; then
              echo "    âš ï¸ Only PNG created"
            else
              echo "    âŒ Render failed"
            fi
          done

          echo "âœ… Rendering complete!"

      - name: List rendered images
        run: |
          echo "ðŸ“ Rendered images:"
          echo ""
          echo "PNG files:"
          find . -name "*.png" -path "*/images/*" | head -20
          echo ""
          echo "SVG files:"
          find . -name "*.svg" -path "*/images/*" | head -20

      - name: Update patterns.json timestamps
        run: |
          if [ -f patterns.json ]; then
            # Update the 'updated' field with today's date
            sed -i "s/\"updated\": \"[0-9-]*\"/\"updated\": \"$(date +%Y-%m-%d)\"/" patterns.json
          fi

      - name: Commit rendered diagrams
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all image files
          git add -A "**/images/*.png" 2>/dev/null || true
          git add -A "**/images/*.svg" 2>/dev/null || true
          git add -A "**/*.png" 2>/dev/null || true
          git add -A "**/*.svg" 2>/dev/null || true
          git add patterns.json 2>/dev/null || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new images to commit"
          else
            git commit -m "ðŸ¤– Auto-render PlantUML diagrams (PNG + SVG)

Rendered images from PlantUML source files.
Images cached via jsDelivr CDN: https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/

Triggered by: ${{ github.event_name }}
Commit: ${{ github.sha }}"
            git push
            echo "âœ… Images committed and pushed"
            echo ""
            echo "ðŸ“¦ CDN URLs will be available at:"
            echo "   https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/catalogue/..."
          fi

      - name: Purge jsDelivr cache (optional)
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          # Purge CDN cache for updated images
          echo "ðŸ”„ Purging jsDelivr cache..."
          for img in $(git diff --name-only HEAD~1 HEAD -- '*.png' '*.svg' 2>/dev/null | head -10); do
            curl -s "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/$img" || true
          done
          echo "âœ… Cache purge requested"
