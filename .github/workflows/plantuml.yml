# PlantUML Auto-Render Workflow
# This workflow automatically validates and renders PlantUML diagrams
# Designed for agentic workflows - works on all branches

name: Render PlantUML Diagrams

on:
  # Triggers on push to any branch - enables agentic workflows
  push:
    branches: [ "**" ]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'

  pull_request:
    branches: [ "main" ]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'

  # Allows manual triggering from Actions tab
  workflow_dispatch:

jobs:
  validate-and-render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate PlantUML files
        run: |
          echo "ðŸ” Validating PlantUML files..."
          ERRORS=0

          for file in $(find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | grep -v node_modules); do
            echo "  Checking $file..."

            # Check for @startuml
            if ! grep -q "@startuml" "$file"; then
              echo "    âŒ Missing @startuml"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Check for @enduml
            if ! grep -q "@enduml" "$file"; then
              echo "    âŒ Missing @enduml"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Check for mixing participant with component
            if grep -q "participant" "$file" && grep -qE "^component|^  component" "$file"; then
              echo "    âŒ Mixing participant (sequence) with component elements"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Check for text inside component() macro
            if grep -qE "component\([^)]+\)\s*\{" "$file"; then
              echo "    âŒ Text inside component() macro - use notes instead"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            echo "    âœ… Valid"
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Validation failed with $ERRORS error(s)"
            exit 1
          fi

          echo "âœ… All PlantUML files validated successfully!"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download PlantUML
        run: |
          mkdir -p /tmp/plantuml
          curl -L -o /tmp/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.8/plantuml-1.2024.8.jar

      - name: Render PlantUML files
        run: |
          find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | while read file; do
            dir=$(dirname "$file")
            filename=$(basename "$file")
            name="${filename%.*}"

            # Determine output directory (sibling 'images' folder)
            if [[ "$dir" == *"/uml"* ]]; then
              output_dir="${dir/\/uml/\/images}"
            else
              output_dir="$dir/images"
            fi

            mkdir -p "$output_dir"

            echo "Rendering: $file -> $output_dir/$name.png"
            java -jar /tmp/plantuml/plantuml.jar -tpng -o "$(cd "$dir" && pwd)/../images" "$file" 2>/dev/null || \
            java -jar /tmp/plantuml/plantuml.jar -tpng -o "$output_dir" "$file"
          done

      - name: Commit rendered diagrams
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A "**/*.png" 2>/dev/null || true
          git add -A "**/images/*.png" 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-render PlantUML diagrams

Automatically generated by GitHub Actions
Triggered by: ${{ github.event_name }}
Commit: ${{ github.sha }}"
            git push
          fi
