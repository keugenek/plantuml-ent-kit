# PlantUML Auto-Render Workflow
# Validates, renders PlantUML diagrams and commits PNG images back to repo
# Designed for agentic workflows - works on all branches

name: Render PlantUML Diagrams

on:
  push:
    branches: ["**"]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'
  pull_request:
    branches: ["main"]
    paths:
      - '**.puml'
      - '**.pu'
      - '**.plantuml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate-and-render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Validate PlantUML files
        run: |
          echo "ðŸ” Validating PlantUML files..."
          ERRORS=0

          for file in $(find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | grep -v node_modules); do
            echo "  Checking $file..."

            if ! grep -q "@startuml" "$file"; then
              echo "    âŒ Missing @startuml"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            if ! grep -q "@enduml" "$file"; then
              echo "    âŒ Missing @enduml"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            if grep -q "participant" "$file" && grep -qE "^component|^  component" "$file"; then
              echo "    âŒ Mixing participant (sequence) with component elements"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            if grep -qE "component\([^)]+\)\s*\{" "$file"; then
              echo "    âŒ Text inside component() macro - use notes instead"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            echo "    âœ… Valid"
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Validation failed with $ERRORS error(s)"
            exit 1
          fi

          echo "âœ… All PlantUML files validated successfully!"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          dot -V

      - name: Download PlantUML
        run: |
          mkdir -p /tmp/plantuml
          curl -L -o /tmp/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.8/plantuml-1.2024.8.jar

      - name: Render changed PlantUML files
        run: |
          echo "ðŸŽ¨ Checking for changed PlantUML files..."

          # Get changed files in this push (compare with parent commit)
          CHANGED_PUML=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E '\.(puml|pu|plantuml)$' || true)

          if [ -z "$CHANGED_PUML" ]; then
            # Fallback: render files where PNG is missing or older than source
            echo "  No git diff available, checking file timestamps..."
            CHANGED_PUML=$(find . -type f \( -name "*.puml" -o -name "*.pu" -o -name "*.plantuml" \) | while read file; do
              dir=$(dirname "$file")
              filename=$(basename "$file")
              name="${filename%.*}"
              if [[ "$dir" == *"/uml"* ]]; then
                output_dir="${dir/\/uml/\/images}"
              else
                output_dir="$dir/images"
              fi
              png_file="$output_dir/$name.png"
              if [ ! -f "$png_file" ] || [ "$file" -nt "$png_file" ]; then
                echo "$file"
              fi
            done)
          fi

          if [ -z "$CHANGED_PUML" ]; then
            echo "âœ… No PlantUML files need rendering"
            exit 0
          fi

          echo "ðŸ“‹ Files to render:"
          echo "$CHANGED_PUML"
          echo ""

          echo "$CHANGED_PUML" | while read file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue

            dir=$(dirname "$file")
            filename=$(basename "$file")
            name="${filename%.*}"

            if [[ "$dir" == *"/uml"* ]]; then
              output_dir="${dir/\/uml/\/images}"
            else
              output_dir="$dir/images"
            fi

            mkdir -p "$output_dir"
            echo "  ðŸ”„ Rendering: $file -> $output_dir/$name.png"
            java -jar /tmp/plantuml/plantuml.jar -tpng -o "$(realpath "$output_dir")" "$file"

            if [ -f "$output_dir/$name.png" ]; then
              echo "    âœ… Success"
            else
              echo "    âš ï¸ Warning: PNG not created"
            fi
          done

          echo "âœ… Rendering complete!"

      - name: List rendered images
        run: |
          echo "ðŸ“ Rendered images:"
          find . -name "*.png" -path "*/images/*" | head -20

      - name: Commit rendered diagrams
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all PNG files
          git add -A "**/images/*.png" 2>/dev/null || true
          git add -A "**/*.png" 2>/dev/null || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No new images to commit"
          else
            git commit -m "ðŸ¤– Auto-render PlantUML diagrams [skip ci]"
            git push
            echo "âœ… Images committed and pushed"
          fi
