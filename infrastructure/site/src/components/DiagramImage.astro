---
interface Props {
  slug: string;
  name: string;
  category?: string;
  source?: string;
}

const { slug, name, category = 'reference-architectures', source } = Astro.props;

// Image URL priority:
// 1. Local cached image (fastest)
// 2. jsDelivr CDN (GitHub cached)
// 3. GitHub raw (fallback)
// 4. Kroki live render (last resort)

const repo = 'keugenek/plantuml-ent-kit';
const branch = 'main';

const localPath = `/images/${slug}.png`;
const jsdelivrUrl = `https://cdn.jsdelivr.net/gh/${repo}@${branch}/catalogue/${category}/images/${slug}.png`;
const githubRawUrl = `https://raw.githubusercontent.com/${repo}/${branch}/catalogue/${category}/images/${slug}.png`;
---

<picture class="diagram-picture" data-slug={slug}>
  <img
    src={localPath}
    alt={name}
    loading="lazy"
    decoding="async"
    data-jsdelivr={jsdelivrUrl}
    data-github={githubRawUrl}
    data-source={source}
    onerror="handleImageError(this)"
  />
</picture>

<script is:inline>
  // Global image error handler with fallback chain
  function handleImageError(img) {
    const jsdelivr = img.dataset.jsdelivr;
    const github = img.dataset.github;
    const source = img.dataset.source;

    // Track which fallback we're on
    const fallback = img.dataset.fallback || '0';

    if (fallback === '0' && jsdelivr) {
      // Try jsDelivr CDN
      img.dataset.fallback = '1';
      img.src = jsdelivr;
    } else if (fallback === '1' && github) {
      // Try GitHub raw
      img.dataset.fallback = '2';
      img.src = github;
    } else if (fallback === '2' && source) {
      // Last resort: live render via Kroki
      img.dataset.fallback = '3';
      img.src = '/kroki/plantuml/png/' + btoa(source);
    } else {
      // All fallbacks failed - show placeholder
      img.style.display = 'none';
      img.parentElement.innerHTML = '<div class="diagram-placeholder">Diagram unavailable</div>';
    }
  }
</script>

<style>
  .diagram-picture {
    display: block;
    background: #fff;
    border-radius: 4px;
    overflow: hidden;
  }

  .diagram-picture img {
    max-width: 100%;
    height: auto;
  }

  .diagram-placeholder {
    padding: 2rem;
    text-align: center;
    color: #666;
    background: #f5f5f5;
  }
</style>
