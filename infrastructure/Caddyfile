# Caddyfile for pattern-diagrams
# Works with Tailscale Funnel for public access

{
    # Global options
    admin off
    auto_https off  # Tailscale handles HTTPS
}

:80 {
    # Aggressive caching for static assets
    header Cache-Control "public, max-age=31536000, immutable" {
        path *.png
        path *.svg
        path *.jpg
        path *.css
        path *.js
        path *.woff2
    }

    # API caching (shorter TTL)
    header Cache-Control "public, max-age=300" {
        path /api/*
    }

    # Gzip compression
    encode gzip

    # Diagram rendering API - proxy to Kroki
    handle /kroki/* {
        uri strip_prefix /kroki
        reverse_proxy kroki:8000 {
            header_down Cache-Control "public, max-age=86400"
        }
    }

    # Static site
    handle {
        reverse_proxy site:80
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # Logging
    log {
        output stdout
        format console
    }
}
